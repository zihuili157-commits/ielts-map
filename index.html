<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS World Tour | é›…æ€ç¯çƒæ‰‹è´¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Noto+Sans+SC:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: "Inter", "Noto Sans SC", sans-serif;
            background-color: #e0e0e0;
            overflow: hidden; 
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        .paper-texture {
            background-color: #fffbf0;
            background-image: linear-gradient(#e5e5e5 1px, transparent 1px);
            background-size: 100% 25px;
            line-height: 25px;
        }

        /* åœ°å›¾å¡«å……è‰² */
        .fill-high { fill: #f1c40f !important; transition: fill 0.5s; filter: drop-shadow(0 0 2px rgba(241, 196, 15, 0.5)); } 
        .fill-mid { fill: #2ecc71 !important; transition: fill 0.5s; }  
        .fill-pass { fill: #fd79a8 !important; transition: fill 0.5s; }  
        .fill-low { fill: #e74c3c !important; transition: fill 0.5s; }  
        .fill-default { fill: #fff; stroke: #2c3e50; stroke-width: 0.5; transition: fill 0.5s; }
        .fill-default:hover { fill: #ecf0f1; cursor: pointer; }

        /* é‚®ç¥¨æ•ˆæœ - åº•éƒ¨å±•æ¶ */
        .stamp-card {
            background: white;
            border: 6px solid white; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stamp-card:hover {
            transform: translateY(-10px) scale(1.05);
            z-index: 10;
            box-shadow: 0 15px 30px rgba(0,0,0,0.25);
        }
        .stamp-card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle, transparent 95%, #000 150%);
            opacity: 0.1;
            pointer-events: none;
        }

        /* HUD æ ·å¼ */
        .hud-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 14px 18px;
            width: 260px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .hud-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            font-weight: 800;
            letter-spacing: 0.05em;
            color: #6B7280;
            text-transform: uppercase;
        }
        .hud-level { color: #3B82F6; font-weight: 700; font-size: 11px; background: #EFF6FF; padding: 2px 8px; border-radius: 4px; }
        .hud-trophy { color: #EAB308; }
        .hud-progress-bg {
            width: 100%; height: 10px; background-color: #F3F4F6; border-radius: 999px; overflow: hidden; margin-top: 2px;
        }
        .hud-progress-bar {
            height: 100%; background-color: #D1D5DB; border-radius: 999px; transition: width 1s ease-out;
        }
        .hud-value { font-size: 0.85rem; color: #9CA3AF; margin-top: 2px; font-family: monospace; font-weight: 600; }

        /* åŠ¨ç”» */
        .tooltip-enter { animation: tooltipIn 0.2s ease-out forwards; }
        @keyframes tooltipIn { from { opacity: 0; transform: translate(-50%, 10px); } to { opacity: 1; transform: translate(-50%, 0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- å›¾æ ‡ç»„ä»¶ ---
        const IconWrapper = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        
        const Icons = {
            MapPin: (p) => <IconWrapper {...p}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconWrapper>,
            Camera: (p) => <IconWrapper {...p}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></IconWrapper>,
            Book: (p) => <IconWrapper {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></IconWrapper>,
            Chart: (p) => <IconWrapper {...p}><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></IconWrapper>,
            Plus: (p) => <IconWrapper {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconWrapper>,
            Minus: (p) => <IconWrapper {...p}><path d="M5 12h14"/></IconWrapper>,
            Refresh: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconWrapper>,
            RotateCcw: (p) => <IconWrapper {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconWrapper>,
            Compass: (p) => <IconWrapper {...p}><circle cx="12" cy="12" r="10"/><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"/></IconWrapper>,
            Loader: (p) => <IconWrapper {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconWrapper>,
            X: (p) => <IconWrapper {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconWrapper>,
            Quote: (p) => <IconWrapper {...p}><path d="M3 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2H4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/><path d="M15 21c3 0 7-1 7-8V5c0-1.25-.756-2.017-2-2h-4c-1.25 0-2 .75-2 1.972V11c0 1.25.75 2 2 2 1 0 1 0 1 1v1c0 1-1 2-2 2s-1 .008-1 1.031V20c0 1 0 1 1 1z"/></IconWrapper>,
            ImageOff: (p) => <IconWrapper {...p}><line x1="2" x2="22" y1="2" y2="22"/><path d="M10.41 6.643A2 2 0 0 1 12.293 6H19a2 2 0 0 1 2 2v11a2 2 0 0 1-1.357 1.936"/><path d="M13.5 13.5 6.5 20.5 3 17"/><path d="M2 12V8a2 2 0 0 1 2-2h1.293"/><path d="M8.5 22H4a2 2 0 0 1-2-2v-2.293"/></IconWrapper>,
            Plane: (p) => <IconWrapper {...p}><path d="M2 12h20"/><path d="m13 2-4 10H5l3 3"/><path d="m11 22 4-10h4l-3-3"/></IconWrapper>,
            Pen: (p) => <IconWrapper {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></IconWrapper>,
            Layers: (p) => <IconWrapper {...p}><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></IconWrapper>,
            List: (p) => <IconWrapper {...p}><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></IconWrapper>,
            Trash: (p) => <IconWrapper {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconWrapper>,
            Trophy: (p) => <IconWrapper {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconWrapper>,
            Edit: (p) => <IconWrapper {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></IconWrapper>
        };

        const GEOJSON_URL = 'https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson';
        const DEFAULT_TARGET_DATE = '2025-12-28';

        const SUBJECT_CONFIG = {
            'L': { label: 'Listening å¬åŠ›', icon: 'ğŸ§', color: '#3498db', parts: ['S1', 'S2', 'S3', 'S4'] },
            'R': { label: 'Reading é˜…è¯»', icon: 'ğŸ“–', color: '#f1c40f', parts: ['P1', 'P2', 'P3'] },
            'W': { label: 'Writing å†™ä½œ', icon: 'âœï¸', color: '#9b59b6', parts: ['Task 1', 'Task 2'] },
            'S': { label: 'Speaking å£è¯­', icon: 'ğŸ—£ï¸', color: '#e67e22', parts: ['Part 1', 'Part 2', 'Part 3'] }
        };

        const DIAGNOSIS_TAGS = {
            'L': ['æ‹¼å†™é”™è¯¯', 'å•å¤æ•°', 'å®šä½å¤±è´¥', 'è·Ÿä¸¢å½•éŸ³', 'åŒä¹‰æ›¿æ¢', 'å¹²æ‰°é¡¹', 'è¯æ±‡ç›²åŒº', 'è¯­é€Ÿè¿‡å¿«'],
            'R': ['é•¿éš¾å¥', 'å®šä½ä¸åˆ°', 'NG/Falseæ··æ·†', 'å•è¯ä¸è¯†', 'æ—¶é—´ä¸å¤Ÿ', 'é€»è¾‘é”™è¯¯', 'ä¸»æ—¨é¢˜'],
            'W': ['é€»è¾‘è·³è·ƒ', 'è§‚ç‚¹ç©ºæ´', 'è¯æ±‡å•ä¸€', 'è¯­æ³•é”™è¯¯', 'è·‘é¢˜', 'å­—æ•°ä¸å¤Ÿ', 'è¿æ¥è¯ç¼ºå¤±', 'å®¡é¢˜ä¸æ¸…'],
            'S': ['å‘éŸ³ä¸å‡†', 'æµåˆ©åº¦', 'è¯æ±‡é‡å¤', 'è¯­æ³•é”™è¯¯', 'å¡é¡¿', 'æ—¶æ€é”™è¯¯', 'å›ç­”å¤ªçŸ­', 'é€»è¾‘ä¸æ¸…']
        };

        // 174ä¸ªå›½å®¶/åœ°åŒºæ˜ å°„
        const COUNTRY_CN_MAP = {
            'AFG': 'é˜¿å¯Œæ±—', 'AGO': 'å®‰å“¥æ‹‰', 'ALB': 'é˜¿å°”å·´å°¼äºš', 'ARE': 'é˜¿è”é…‹', 'ARG': 'é˜¿æ ¹å»·', 'ARM': 'äºšç¾å°¼äºš', 'AUS': 'æ¾³å¤§åˆ©äºš', 'AUT': 'å¥¥åœ°åˆ©', 'AZE': 'é˜¿å¡æ‹œç–†',
            'BDI': 'å¸ƒéš†è¿ª', 'BEL': 'æ¯”åˆ©æ—¶', 'BEN': 'è´å®', 'BFA': 'å¸ƒåŸºçº³æ³•ç´¢', 'BGD': 'å­ŸåŠ æ‹‰å›½', 'BGR': 'ä¿åŠ åˆ©äºš', 'BHS': 'å·´å“ˆé©¬', 'BIH': 'æ³¢é»‘', 'BLR': 'ç™½ä¿„ç½—æ–¯', 'BLZ': 'ä¼¯åˆ©å…¹', 'BOL': 'ç»åˆ©ç»´äºš', 'BRA': 'å·´è¥¿', 'BRN': 'æ–‡è±', 'BTN': 'ä¸ä¸¹', 'BWA': 'åšèŒ¨ç“¦çº³',
            'CAF': 'ä¸­é', 'CAN': 'åŠ æ‹¿å¤§', 'CHE': 'ç‘å£«', 'CHL': 'æ™ºåˆ©', 'CHN': 'ä¸­å›½', 'CIV': 'ç§‘ç‰¹è¿ªç“¦', 'CMR': 'å–€éº¦éš†', 'COD': 'åˆšæœ(é‡‘)', 'COG': 'åˆšæœ(å¸ƒ)', 'COL': 'å“¥ä¼¦æ¯”äºš', 'CRI': 'å“¥æ–¯è¾¾é»åŠ ', 'CUB': 'å¤å·´', 'CYP': 'å¡æµ¦è·¯æ–¯', 'CZE': 'æ·å…‹',
            'DEU': 'å¾·å›½', 'DJI': 'å‰å¸ƒæ', 'DNK': 'ä¸¹éº¦', 'DOM': 'å¤šç±³å°¼åŠ ', 'DZA': 'é˜¿å°”åŠåˆ©äºš',
            'ECU': 'å„ç“œå¤šå°”', 'EGY': 'åŸƒåŠ', 'ERI': 'å„ç«‹ç‰¹é‡Œäºš', 'ESP': 'è¥¿ç­ç‰™', 'EST': 'çˆ±æ²™å°¼äºš', 'ETH': 'åŸƒå¡ä¿„æ¯”äºš',
            'FIN': 'èŠ¬å…°', 'FJI': 'æ–æµ', 'FLK': 'ç¦å…‹å…°ç¾¤å²›', 'FRA': 'æ³•å›½',
            'GAB': 'åŠ è“¬', 'GBR': 'è‹±å›½', 'GEO': 'æ ¼é²å‰äºš', 'GHA': 'åŠ çº³', 'GIN': 'å‡ å†…äºš', 'GMB': 'å†ˆæ¯”äºš', 'GNB': 'å‡ å†…äºšæ¯”ç»', 'GNQ': 'èµ¤é“å‡ å†…äºš', 'GRC': 'å¸Œè…Š', 'GRL': 'æ ¼é™µå…°', 'GTM': 'å±åœ°é©¬æ‹‰', 'GUY': 'åœ­äºšé‚£',
            'HND': 'æ´ªéƒ½æ‹‰æ–¯', 'HRV': 'å…‹ç½—åœ°äºš', 'HTI': 'æµ·åœ°', 'HUN': 'åŒˆç‰™åˆ©',
            'IDN': 'å°åº¦å°¼è¥¿äºš', 'IND': 'å°åº¦', 'IRL': 'çˆ±å°”å…°', 'IRN': 'ä¼Šæœ—', 'IRQ': 'ä¼Šæ‹‰å…‹', 'ISL': 'å†°å²›', 'ISR': 'ä»¥è‰²åˆ—', 'ITA': 'æ„å¤§åˆ©',
            'JAM': 'ç‰™ä¹°åŠ ', 'JOR': 'çº¦æ—¦', 'JPN': 'æ—¥æœ¬',
            'KAZ': 'å“ˆè¨å…‹æ–¯å¦', 'KEN': 'è‚¯å°¼äºš', 'KGZ': 'å‰å°”å‰æ–¯æ–¯å¦', 'KHM': 'æŸ¬åŸ”å¯¨', 'KOR': 'éŸ©å›½', 'XKX': 'ç§‘ç´¢æ²ƒ', 'KWT': 'ç§‘å¨ç‰¹',
            'LAO': 'è€æŒ', 'LBN': 'é»å·´å«©', 'LBR': 'åˆ©æ¯”é‡Œäºš', 'LBY': 'åˆ©æ¯”äºš', 'LKA': 'æ–¯é‡Œå…°å¡', 'LSO': 'è±ç´¢æ‰˜', 'LTU': 'ç«‹é™¶å®›', 'LUX': 'å¢æ£®å ¡', 'LVA': 'æ‹‰è„±ç»´äºš',
            'MAR': 'æ‘©æ´›å“¥', 'MDA': 'æ‘©å°”å¤šç“¦', 'MDG': 'é©¬è¾¾åŠ æ–¯åŠ ', 'MEX': 'å¢¨è¥¿å“¥', 'MKD': 'åŒ—é©¬å…¶é¡¿', 'MLI': 'é©¬é‡Œ', 'MMR': 'ç¼…ç”¸', 'MNE': 'é»‘å±±', 'MNG': 'è’™å¤', 'MOZ': 'è«æ¡‘æ¯”å…‹', 'MRT': 'æ¯›é‡Œå¡”å°¼äºš', 'MWI': 'é©¬æ‹‰ç»´', 'MYS': 'é©¬æ¥è¥¿äºš',
            'NAM': 'çº³ç±³æ¯”äºš', 'NCL': 'æ–°å–€é‡Œå¤šå°¼äºš', 'NER': 'å°¼æ—¥å°”', 'NGA': 'å°¼æ—¥åˆ©äºš', 'NIC': 'å°¼åŠ æ‹‰ç“œ', 'NLD': 'è·å…°', 'NOR': 'æŒªå¨', 'NPL': 'å°¼æ³Šå°”', 'NZL': 'æ–°è¥¿å…°',
            'OMN': 'é˜¿æ›¼',
            'PAK': 'å·´åŸºæ–¯å¦', 'PAN': 'å·´æ‹¿é©¬', 'PER': 'ç§˜é²', 'PHL': 'è²å¾‹å®¾', 'PNG': 'å·´å¸ƒäºšæ–°å‡ å†…äºš', 'POL': 'æ³¢å…°', 'PRI': 'æ³¢å¤šé»å„', 'PRK': 'æœé²œ', 'PRT': 'è‘¡è„ç‰™', 'PRY': 'å·´æ‹‰åœ­', 'PSE': 'å·´å‹’æ–¯å¦',
            'QAT': 'å¡å¡”å°”',
            'ROU': 'ç½—é©¬å°¼äºš', 'RUS': 'ä¿„ç½—æ–¯', 'RWA': 'å¢æ—ºè¾¾',
            'SAU': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', 'SDN': 'è‹ä¸¹', 'SEN': 'å¡å†…åŠ å°”', 'SLB': 'æ‰€ç½—é—¨ç¾¤å²›', 'SLE': 'å¡æ‹‰åˆ©æ˜‚', 'SLV': 'è¨å°”ç“¦å¤š', 'SOM': 'ç´¢é©¬é‡Œ', 'SRB': 'å¡å°”ç»´äºš', 'SSD': 'å—è‹ä¸¹', 'SUR': 'è‹é‡Œå—', 'SVK': 'æ–¯æ´›ä¼å…‹', 'SVN': 'æ–¯æ´›æ–‡å°¼äºš', 'SWE': 'ç‘å…¸', 'SWZ': 'æ–¯å¨å£«å…°', 'SYR': 'å™åˆ©äºš',
            'TCD': 'ä¹å¾—', 'TGO': 'å¤šå“¥', 'THA': 'æ³°å›½', 'TJK': 'å¡”å‰å…‹æ–¯å¦', 'TKM': 'åœŸåº“æ›¼æ–¯å¦', 'TLS': 'ä¸œå¸æ±¶', 'TTO': 'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥', 'TUN': 'çªå°¼æ–¯', 'TUR': 'åœŸè€³å…¶', 'TWN': 'å°æ¹¾', 'TZA': 'å¦æ¡‘å°¼äºš',
            'UGA': 'ä¹Œå¹²è¾¾', 'UKR': 'ä¹Œå…‹å…°', 'URY': 'ä¹Œæ‹‰åœ­', 'USA': 'ç¾å›½', 'UZB': 'ä¹Œå…¹åˆ«å…‹æ–¯å¦',
            'VEN': 'å§”å†…ç‘æ‹‰', 'VNM': 'è¶Šå—', 'VUT': 'ç“¦åŠªé˜¿å›¾',
            'YEM': 'ä¹Ÿé—¨',
            'ZAF': 'å—é', 'ZMB': 'èµæ¯”äºš', 'ZWE': 'æ´¥å·´å¸ƒéŸ¦'
        };

        const LANDMARKS = [
            { id: 1, name: 'æ–°å¤©é¹…å ¡', location: 'Germany å¾·å›½', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f8/Schloss_Neuschwanstein_2013.jpg/800px-Schloss_Neuschwanstein_2013.jpg', desc: 'è¿ªå£«å°¼åŸå ¡çš„åŸå‹', quote: 'æ¯ä¸ªäººçš„å¿ƒä¸­ï¼Œéƒ½ä½ç€ä¸€ä¸ªç«¥è¯ã€‚' },
            { id: 2, name: 'è‡ªç”±å¥³ç¥åƒ', location: 'USA ç¾å›½', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a1/Statue_of_Liberty_7.jpg/640px-Statue_of_Liberty_7.jpg', desc: 'ç…§è€€ä¸–ç•Œçš„è‡ªç”±ä¹‹å…‰', quote: 'è¯»ä¸‡å·ä¹¦ï¼Œè¡Œä¸‡é‡Œè·¯ã€‚' },
            { id: 3, name: 'ä¸‡é‡Œé•¿åŸ', location: 'China ä¸­å›½', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/The_Great_Wall_of_China_at_Jinshanling-edit.jpg/640px-The_Great_Wall_of_China_at_Jinshanling-edit.jpg', desc: 'å·¨é¾™èœ¿èœ’ï¼Œåƒå¹´å®ˆæŠ¤', quote: 'ä¸åˆ°é•¿åŸéå¥½æ±‰ï¼Œä¸èµ°å¤©æ¶¯æ€çŸ¥è¿œã€‚' },
            { id: 5, name: 'æ»¨æµ·æ¹¾é‡‘æ²™', location: 'Singapore æ–°åŠ å¡', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f9/Marina_Bay_Sands_in_the_evening_-_20101120.jpg/800px-Marina_Bay_Sands_in_the_evening_-_20101120.jpg', desc: 'èŠ±å›­åŸå¸‚çš„ç©ºä¸­èŠ±å›­', quote: 'æœªæ¥ä¹‹åŸï¼Œä»Šæ—¥å¯è§ã€‚' },
            { id: 7, name: 'å¤§ç¬¨é’Ÿ', location: 'UK è‹±å›½', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/9/93/Clock_Tower_-_Palace_of_Westminster%2C_London_-_May_2007.jpg/640px-Clock_Tower_-_Palace_of_Westminster%2C_London_-_May_2007.jpg', desc: 'æ³°æ™¤å£«æ²³ç•”çš„é’Ÿå£°', quote: 'æ—¶é—´ä¼šæµé€ï¼Œä½†è®°å¿†æ°¸å­˜ã€‚' },
            { id: 8, name: 'æ³°å§¬é™µ', location: 'India å°åº¦', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/Taj_Mahal%2C_Agra%2C_India_edit3.jpg/640px-Taj_Mahal%2C_Agra%2C_India_edit3.jpg', desc: 'æ°¸æ’é¢é¢Šä¸Šçš„ä¸€æ»´æ³ª', quote: 'çˆ±æ˜¯æ—…è¡Œä¸­é€šç”¨çš„è¯­è¨€ã€‚' },
            { id: 9, name: 'ç½—é©¬æ–—å…½åœº', location: 'Italy æ„å¤§åˆ©', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/de/Colosseo_2020.jpg/640px-Colosseo_2020.jpg', desc: 'è§’æ–—å£«çš„è£è€€ä¸è¡€æ³ª', quote: 'æ¡æ¡å¤§è·¯é€šç½—é©¬ï¼Œæ„¿ä½ æ‰¾åˆ°å±äºä½ çš„é‚£æ¡è·¯ã€‚' },
            { id: 10, name: 'é©¬ä¸˜æ¯”ä¸˜', location: 'Peru ç§˜é²', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Machu_Picchu%2C_Peru.jpg/640px-Machu_Picchu%2C_Peru.jpg', desc: 'äº‘ç«¯çš„å¤±è½ä¹‹åŸ', quote: 'è¿·è·¯ä¹Ÿæ˜¯ä¸€ç§æ¢ç´¢ä¸–ç•Œçš„æ–¹å¼ã€‚' },
            { id: 11, name: 'é‡‘å­—å¡”', location: 'Egypt åŸƒåŠ', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/af/All_Gizah_Pyramids.jpg/640px-All_Gizah_Pyramids.jpg', desc: 'æ²™æ¼ ä¸­çš„æ°¸æ’è°œé¢˜', quote: 'å†å²åœ¨æ²‰ç¡ï¼Œç­‰å¾…æ—…äººçš„è„šæ­¥å°†å…¶å”¤é†’ã€‚' },
            { id: 12, name: 'å¸•ç‰¹å†œç¥åº™', location: 'Greece å¸Œè…Š', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/The_Parthenon_in_Athens.jpg/640px-The_Parthenon_in_Athens.jpg', desc: 'é›…å…¸å«åŸçš„è£è€€', quote: 'æ–‡æ˜çš„å¾®å…‰ï¼Œç…§äº®äº†åƒå¹´çš„é»‘æš—ã€‚' },
            { id: 13, name: 'é‡‘é—¨å¤§æ¡¥', location: 'USA ç¾å›½', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0c/GoldenGateBridge-001.jpg/640px-GoldenGateBridge-001.jpg', desc: 'è·¨è¶Šæµ·æ¹¾çš„çº¢è‰²å¥‡è¿¹', quote: 'æ¡¥æ¢è¿æ¥çš„ä¸ä»…æ˜¯åœŸåœ°ï¼Œæ›´æ˜¯äººå¿ƒã€‚' },
            { id: 14, name: 'åœ£å®¶å ‚', location: 'Spain è¥¿ç­ç‰™', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/Sagrada_Familia_01.jpg/640px-Sagrada_Familia_01.jpg', desc: 'ä¸Šå¸çš„å»ºç­‘å¸ˆä¹‹ä½œ', quote: 'æœªå®Œæˆï¼Œæ„å‘³ç€æ— é™çš„å¯èƒ½ã€‚' },
            { id: 15, name: 'ä½©ç‰¹æ‹‰å¤åŸ', location: 'Jordan çº¦æ—¦', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2f/Treasury_petra_crop.jpeg/640px-Treasury_petra_crop.jpeg', desc: 'ç«ç‘°è‰²çš„å²©çŸ³å¥‡è¿¹', quote: 'ç©¿è¶Šåƒå¹´çš„æ—¶å…‰ï¼Œåªä¸ºä¸ä½ ç›¸é‡ã€‚' },
            { id: 17, name: 'å´å“¥çªŸ', location: 'Cambodia æŸ¬åŸ”å¯¨', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Angkor_Wat.jpg/640px-Angkor_Wat.jpg', desc: 'æ ‘æ ¹ç¼ ç»•çš„ç¥åœ£åºŸå¢Ÿ', quote: 'å†…å¿ƒçš„å®é™ï¼Œæ˜¯æ—…é€”ä¸­æœ€ç¾çš„é£æ™¯ã€‚' },
            { id: 18, name: 'å°¼äºšåŠ æ‹‰ç€‘å¸ƒ', location: 'Canada/USA', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ab/3Falls_Niagara.jpg/640px-3Falls_Niagara.jpg', desc: 'é›·ç¥ä¹‹æ°´çš„å’†å“®', quote: 'å“ªæ€•å è½ï¼Œä¹Ÿè¦å‘å‡ºéœ‡è€³æ¬²è‹çš„å›å“ã€‚' },
            { id: 20, name: 'å·¨çŸ³é˜µ', location: 'UK è‹±å›½', img: 'https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Stonehenge2007_07_30.jpg/640px-Stonehenge2007_07_30.jpg', desc: 'å²å‰æ–‡æ˜çš„ç¥ç§˜å›å“', quote: 'ä¸–ç•Œå¾ˆå¤§ï¼Œæˆ‘ä»¬å¾ˆå°ï¼Œä½†è¿™ä¸å¦¨ç¢æˆ‘ä»¬å»æ¢ç´¢ã€‚' },
        ];

        // --- å·¥å…·å‡½æ•°ï¼šåˆ†æ•°è®¡ç®— ---
        // å‡çº§ç‰ˆï¼šé›…æ€å®˜æ–¹è¯„åˆ†å¯¹ç…§è¡¨ (Accurate for Academic 2024)
        const getBandScore = (count, type) => {
            const c = parseInt(count);
            if (isNaN(c)) return 0;
            
            if (type === 'L') {
                // å¬åŠ›è¯„åˆ†æ ‡å‡† (Listening)
                if (c >= 39) return 9.0;
                if (c >= 37) return 8.5;
                if (c >= 35) return 8.0;
                if (c >= 32) return 7.5; 
                if (c >= 30) return 7.0;
                if (c >= 26) return 6.5; 
                if (c >= 23) return 6.0;
                if (c >= 18) return 5.5; 
                if (c >= 16) return 5.0; 
                if (c >= 13) return 4.5;
                if (c >= 10) return 4.0;
                return 3.5;
            } else if (type === 'R') {
                // é˜…è¯»è¯„åˆ†æ ‡å‡† (Academic Reading) - é€šå¸¸æ¯”å¬åŠ›ç¨å¾®ä¸¥æ ¼ä¸€ç‚¹
                if (c >= 39) return 9.0;
                if (c >= 37) return 8.5;
                if (c >= 35) return 8.0;
                if (c >= 33) return 7.5; // ä¸åŒç‚¹
                if (c >= 30) return 7.0;
                if (c >= 27) return 6.5; // ä¸åŒç‚¹
                if (c >= 23) return 6.0;
                if (c >= 19) return 5.5; // ä¸åŒç‚¹
                if (c >= 15) return 5.0; // ä¸åŒç‚¹
                if (c >= 13) return 4.5;
                if (c >= 10) return 4.0;
                return 3.5;
            }
            return parseFloat(count) || 0; 
        };

        const processTestStats = (records, subject) => {
            if (subject !== 'L' && subject !== 'R') {
                const validRecords = records.filter(r => r.subject === subject);
                const avg = validRecords.length ? (validRecords.reduce((a, b) => a + parseFloat(b.score), 0) / validRecords.length).toFixed(1) : '-';
                const trend = validRecords.sort((a,b) => new Date(a.date) - new Date(b.date)).map(r => ({ label: `${r.date.slice(5)}`, value: r.score }));
                return { avg, trend, count: validRecords.length };
            }

            const groups = {};
            records.filter(r => r.subject === subject).forEach(r => {
                const key = `${r.book}|${r.test}`;
                if (!groups[key]) groups[key] = { parts: {}, date: r.date, book: r.book, test: r.test };
                groups[key].parts[r.part] = parseFloat(r.score); 
                if (new Date(r.date) > new Date(groups[key].date)) groups[key].date = r.date;
            });

            const completedTests = [];
            Object.values(groups).forEach(g => {
                const parts = g.parts;
                let totalCorrect = 0;
                let isComplete = false;

                if (subject === 'L') {
                    if (parts['S1']!=null && parts['S2']!=null && parts['S3']!=null && parts['S4']!=null) {
                        totalCorrect = parts['S1'] + parts['S2'] + parts['S3'] + parts['S4'];
                        isComplete = true;
                    }
                } else if (subject === 'R') {
                    if (parts['P1']!=null && parts['P2']!=null && parts['P3']!=null) {
                        totalCorrect = parts['P1'] + parts['P2'] + parts['P3'];
                        isComplete = true;
                    }
                }

                if (isComplete) {
                    completedTests.push({
                        label: `${g.book} ${g.test}`,
                        date: g.date,
                        value: getBandScore(totalCorrect, subject),
                        rawTotal: totalCorrect
                    });
                }
            });

            completedTests.sort((a, b) => new Date(a.date) - new Date(b.date));
            const avg = completedTests.length ? (completedTests.reduce((a, b) => a + b.value, 0) / completedTests.length).toFixed(1) : '-';
            return { avg, trend: completedTests, count: completedTests.length };
        };

        const SketchImage = ({ src, alt, className }) => {
            const [error, setError] = useState(false);
            useEffect(() => { setError(false); }, [src]);
            return (
                <div className={`relative overflow-hidden border-4 border-white shadow-md rounded-sm ${className} bg-gray-100`}>
                    {!error ? (
                        <img src={src} alt={alt} onError={() => setError(true)} referrerPolicy="no-referrer" className="w-full h-full object-cover transition-transform duration-700 hover:scale-110" style={{ filter: 'contrast(120%) sepia(20%) saturate(140%) brightness(1.05) hue-rotate(-5deg)', mixBlendMode: 'multiply' }} />
                    ) : (
                        <div className="w-full h-full flex flex-col items-center justify-center text-gray-400 bg-gray-200 gap-2"><Icons.ImageOff size={24} /><span className="text-xs text-center px-2">{alt}</span></div>
                    )}
                    <div className="absolute inset-0 bg-yellow-50 opacity-20 pointer-events-none mix-blend-overlay"></div>
                </div>
            );
        };

        function App() {
            const [records, setRecords] = useState(() => JSON.parse(localStorage.getItem('ielts_records') || '[]'));
            const [unlockedLandmarks, setUnlockedLandmarks] = useState(() => JSON.parse(localStorage.getItem('ielts_landmarks') || '[]'));
            const [mapCycle, setMapCycle] = useState(() => parseInt(localStorage.getItem('ielts_map_cycle') || '1'));
            const [mapResetDate, setMapResetDate] = useState(() => {
                const d = localStorage.getItem('ielts_map_reset_date');
                return d ? new Date(d) : new Date(0); 
            });
            const [targetDateStr, setTargetDateStr] = useState(() => localStorage.getItem('ielts_target_date') || DEFAULT_TARGET_DATE);
            
            // New: Custom Tags State
            const [customTagsMap, setCustomTagsMap] = useState(() => JSON.parse(localStorage.getItem('ielts_custom_tags') || '{"L":[],"R":[],"W":[],"S":[]}'));

            const [showDataCenter, setShowDataCenter] = useState(false);
            const [showJournal, setShowJournal] = useState(false);
            const [showLandmarkModal, setShowLandmarkModal] = useState(false);
            const [currentLandmark, setCurrentLandmark] = useState(null);
            const [notification, setNotification] = useState(null);

            useEffect(() => {
                localStorage.setItem('ielts_records', JSON.stringify(records));
                localStorage.setItem('ielts_landmarks', JSON.stringify(unlockedLandmarks));
                localStorage.setItem('ielts_map_cycle', mapCycle.toString());
                localStorage.setItem('ielts_map_reset_date', mapResetDate.toISOString());
                localStorage.setItem('ielts_target_date', targetDateStr);
                localStorage.setItem('ielts_custom_tags', JSON.stringify(customTagsMap));
            }, [records, unlockedLandmarks, mapCycle, mapResetDate, targetDateStr, customTagsMap]);

            const showToast = (text, type = 'info') => {
                setNotification({ text, type });
                setTimeout(() => setNotification(null), 3000);
            };

            const handleAddCustomTag = (subject, tag) => {
                if (!customTagsMap[subject].includes(tag)) {
                    setCustomTagsMap(prev => ({
                        ...prev,
                        [subject]: [...(prev[subject] || []), tag]
                    }));
                }
            };

            const handleAddRecord = (newRecord) => {
                let recordWithMeta = { ...newRecord };
                
                if (newRecord.subject === 'L' || newRecord.subject === 'R') {
                    const activeRecords = records.filter(r => new Date(r.date) >= mapResetDate && (r.subject === 'L' || r.subject === 'R'));
                    const usedCountryIds = activeRecords.map(r => r.countryId).filter(id => id);
                    const allCountryIds = Object.keys(COUNTRY_CN_MAP);
                    let availableIds = allCountryIds.filter(id => !usedCountryIds.includes(id));
                    
                    if (availableIds.length === 0) {
                        availableIds = allCountryIds; 
                    }
                    
                    const randomId = availableIds[Math.floor(Math.random() * availableIds.length)];
                    recordWithMeta.countryId = randomId;
                } else if (newRecord.subject === 'W' || newRecord.subject === 'S') {
                    const undiscovered = LANDMARKS.filter(l => !unlockedLandmarks.find(ul => ul.id === l.id));
                    if (undiscovered.length > 0) {
                        const newLm = undiscovered[Math.floor(Math.random() * undiscovered.length)];
                        setUnlockedLandmarks([...unlockedLandmarks, newLm]);
                        setCurrentLandmark(newLm);
                        setShowLandmarkModal(true);
                        recordWithMeta.landmarkId = newLm.id; 
                    } else {
                        showToast("å¤ªæ£’äº†ï¼æ‰€æœ‰åœ°æ ‡å·²æ”¶é›†å®Œæ¯•ï¼ğŸ‰", 'success');
                    }
                }

                setRecords([recordWithMeta, ...records]);
                if (newRecord.subject === 'L' || newRecord.subject === 'R') {
                    showToast(`åœ°å›¾å·²ç‚¹äº®ï¼š${COUNTRY_CN_MAP[recordWithMeta.countryId]}!`, 'success');
                }
            };

            const handleDeleteRecord = (id) => {
                const recordToDelete = records.find(r => r.id === id);
                const newRecords = records.filter(r => r.id !== id);
                setRecords(newRecords);

                if (recordToDelete && recordToDelete.landmarkId) {
                    const isStillUsed = newRecords.some(r => r.landmarkId === recordToDelete.landmarkId);
                    if (!isStillUsed) {
                        setUnlockedLandmarks(prev => prev.filter(l => l.id !== recordToDelete.landmarkId));
                        showToast("å…³è”åœ°æ ‡å·²é‡æ–°é”å®š", 'info');
                    }
                }
                showToast("è®°å½•å·²åˆ é™¤", 'info');
            };

            const handleMapReset = () => {
                if (confirm("ğŸ‰ æ­å–œä½ ç‚¹äº®äº†æ‰€æœ‰å›½å®¶ï¼ç¡®å®šè¦å¼€å¯ä¸‹ä¸€è½®æ¢ç´¢å—ï¼Ÿ(å†å²è®°å½•ä¿ç•™ï¼Œåœ°å›¾é¢œè‰²é‡ç½®)")) {
                    setMapCycle(prev => prev + 1);
                    setMapResetDate(new Date()); 
                    showToast(`æ¬¢è¿æ¥åˆ° World Tour Level ${mapCycle + 1} ! ğŸš€`, 'success');
                }
            };

            const handleShowLandmark = (landmark) => {
                setCurrentLandmark(landmark);
                setShowLandmarkModal(true);
            };

            return (
                <div className="flex h-screen w-screen overflow-hidden">
                    <Sidebar 
                        onAddRecord={handleAddRecord} 
                        onOpenData={() => setShowDataCenter(true)} 
                        onOpenJournal={() => setShowJournal(true)} 
                        targetDateStr={targetDateStr}
                        setTargetDateStr={setTargetDateStr}
                        customTagsMap={customTagsMap}
                        onSaveCustomTag={handleAddCustomTag}
                    />
                    <div className="flex-1 relative bg-[#89cff0]">
                        <HandDrawnMap 
                            records={records} 
                            mapResetDate={mapResetDate}
                            mapCycle={mapCycle}
                            onMapReset={handleMapReset}
                            unlockedLandmarks={unlockedLandmarks}
                            totalLandmarksCount={LANDMARKS.length}
                            totalCountriesCount={174}
                            onShowLandmark={handleShowLandmark}
                        />
                    </div>
                    {showDataCenter && <DataCenter records={records} onDeleteRecord={handleDeleteRecord} onClose={() => setShowDataCenter(false)} />}
                    {showJournal && <Journal records={records} onClose={() => setShowJournal(false)} />}
                    {showLandmarkModal && currentLandmark && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in fade-in duration-300">
                            <div className="relative bg-[#fdfbf7] p-6 shadow-2xl transform rotate-1 max-w-sm w-full flex flex-col items-center">
                                <div className="absolute -top-3 left-1/2 transform -translate-x-1/2 w-32 h-8 bg-yellow-200/80 rotate-1 shadow-sm z-10"></div>
                                <button onClick={() => setShowLandmarkModal(false)} className="absolute -top-4 -right-4 bg-red-500 text-white p-2 rounded-full border-2 border-white shadow-md hover:bg-red-600 transition-colors z-20"><Icons.X size={20} /></button>
                                <div className="aspect-square w-full mb-4 relative group bg-white p-2 shadow-sm border border-gray-200">
                                    <SketchImage src={currentLandmark.img} alt={currentLandmark.name} className="w-full h-full" />
                                </div>
                                <h2 className="text-3xl font-bold text-[#2c3e50] text-center mb-1" style={{ fontFamily: '"Comic Sans MS", cursive' }}>{currentLandmark.name}</h2>
                                <div className="flex justify-center items-center gap-2 text-gray-500 text-sm mb-4"><Icons.MapPin size={14} /> {currentLandmark.location}</div>
                                <p className="text-center text-gray-600 font-serif italic text-sm mb-4 px-2">"{currentLandmark.desc}"</p>
                                <div className="w-full border-t-2 border-dashed border-gray-300 pt-4 mt-2">
                                    <div className="flex gap-2 text-gray-400 mb-1 justify-center"><Icons.Quote size={16} className="transform rotate-180"/></div>
                                    <p className="text-center text-[#e1685a] font-hand font-medium text-lg leading-relaxed" style={{ fontFamily: '"Comic Sans MS", cursive' }}>{currentLandmark.quote}</p>
                                </div>
                            </div>
                        </div>
                    )}
                    {notification && (
                        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none">
                            <div className="bg-[#2c3e50] text-white px-6 py-3 rounded-full shadow-2xl animate-bounce flex items-center gap-3 border-2 border-white">
                                {notification.type === 'error' ? <Icons.X size={18} /> : <Icons.MapPin size={18} className="text-[#e6b32e]" />}
                                <span className="font-bold">{notification.text}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // --- Sidebar ---
        function Sidebar({ onAddRecord, onOpenData, onOpenJournal, targetDateStr, setTargetDateStr, customTagsMap, onSaveCustomTag }) {
            const [form, setForm] = useState({ book: 'Cam 20', test: 'Test 1', subject: 'L', part: 'S1', score: '', topic: '', tags: [], note: '' });
            const [daysLeft, setDaysLeft] = useState(0);
            const [customTag, setCustomTag] = useState('');
            const [showCustomTagInput, setShowCustomTagInput] = useState(false);
            const [isEditingDate, setIsEditingDate] = useState(false);
            const [tempDate, setTempDate] = useState(targetDateStr);

            useEffect(() => {
                const diff = Math.ceil((new Date(targetDateStr) - new Date()) / (1000*60*60*24));
                setDaysLeft(diff > 0 ? diff : 0);
            }, [targetDateStr]);

            const updateField = (f, v) => setForm(prev => ({ ...prev, [f]: v }));
            
            const handleSubjectChange = (e) => {
                const newSub = e.target.value;
                const defaultPart = SUBJECT_CONFIG[newSub].parts[0]; 
                setForm(prev => ({
                    ...prev,
                    subject: newSub,
                    part: defaultPart,
                    tags: [] // Clear tags on subject switch? Optional, but safer
                }));
            };

            const toggleTag = (tag) => {
                setForm(prev => {
                    const newTags = prev.tags.includes(tag) ? prev.tags.filter(t => t !== tag) : [...prev.tags, tag];
                    return { ...prev, tags: newTags };
                });
            };

            const addCustomTag = () => {
                if (customTag.trim()) {
                    const newTag = customTag.trim();
                    toggleTag(newTag);
                    onSaveCustomTag(form.subject, newTag); // Persist tag
                    setCustomTag('');
                    setShowCustomTagInput(false);
                }
            };

            const handleSubmit = () => {
                if (!form.score && form.score !== 0) return alert('è¯·å¡«å†™åˆ†æ•°/å¯¹é¢˜æ•°');
                onAddRecord({ ...form, id: Date.now(), date: new Date().toISOString().split('T')[0] });
                setForm(prev => ({ ...prev, score: '', topic: '', tags: [], note: '' }));
            };

            const saveDate = () => {
                setTargetDateStr(tempDate);
                setIsEditingDate(false);
            };

            const books = Array.from({length: 20}, (_, i) => `Cam ${20-i}`).concat(Array.from({length: 9}, (_, i) => `æœºç» ${9-i}`));
            const currentConfig = SUBJECT_CONFIG[form.subject];
            
            // Merge default tags with custom tags for the current subject
            const allAvailableTags = [...DIAGNOSIS_TAGS[form.subject], ...(customTagsMap[form.subject] || [])];
            // Remove duplicates just in case
            const uniqueAvailableTags = [...new Set(allAvailableTags)];

            return (
                <div className="w-[380px] h-full bg-white border-r border-gray-300 flex flex-col shadow-xl z-20">
                    <div className="p-6 border-b-2 border-[#2c3e50] flex items-center gap-2">
                        <Icons.Compass size={28} className="text-[#2c3e50]" />
                        <h1 className="text-2xl font-black tracking-tighter text-[#2c3e50]">IELTS ATLAS</h1>
                    </div>
                    
                    {/* å€’è®¡æ—¶æ¨¡å— */}
                    <div className="p-4 bg-[#2c3e50] text-white mx-4 mt-4 rounded-md shadow-md">
                        <div className="flex justify-between items-center mb-1">
                            <span className="text-xs tracking-widest opacity-80 font-mono">MISSION DEADLINE</span>
                            <button onClick={() => setIsEditingDate(!isEditingDate)} className="text-gray-400 hover:text-white transition-colors"><Icons.Edit size={14}/></button>
                        </div>
                        {isEditingDate ? (
                            <div className="flex gap-2 items-center">
                                <input type="date" className="text-black text-sm p-1 rounded w-full" value={tempDate} onChange={e => setTempDate(e.target.value)} />
                                <button onClick={saveDate} className="bg-[#f1c40f] text-[#2c3e50] px-2 py-1 rounded text-xs font-bold">OK</button>
                            </div>
                        ) : (
                            <span className="text-xl font-bold text-[#f1c40f] font-mono block text-right">{daysLeft} DAYS LEFT</span>
                        )}
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 space-y-5">
                        <div className="flex gap-3">
                            <div className="flex-1"><label className="block text-xs font-bold text-gray-400 mb-1 uppercase">Source</label><select className="w-full p-2 border border-gray-300 rounded font-sans text-sm" value={form.book} onChange={e=>updateField('book', e.target.value)}>{books.map(b => <option key={b}>{b}</option>)}</select></div>
                            <div className="w-24"><label className="block text-xs font-bold text-gray-400 mb-1 uppercase">Test</label><select className="w-full p-2 border border-gray-300 rounded font-sans text-sm" value={form.test} onChange={e=>updateField('test', e.target.value)}>{['Test 1','Test 2','Test 3','Test 4'].map(t => <option key={t}>{t}</option>)}</select></div>
                        </div>
                        <div className="flex gap-3">
                            <div className="flex-1">
                                <label className="block text-xs font-bold text-gray-400 mb-1 uppercase">Subject</label>
                                <select className="w-full p-2 border border-gray-300 rounded font-sans text-sm font-bold" style={{ color: currentConfig.color }} value={form.subject} onChange={handleSubjectChange}>
                                    {Object.entries(SUBJECT_CONFIG).map(([k, v]) => (<option key={k} value={k}>{v.icon} {v.label}</option>))}
                                </select>
                            </div>
                            <div className="w-24"><label className="block text-xs font-bold text-gray-400 mb-1 uppercase">Part</label><select className="w-full p-2 border border-gray-300 rounded font-sans text-sm" value={form.part} onChange={e=>updateField('part', e.target.value)}>{currentConfig.parts.map(p => <option key={p}>{p}</option>)}</select></div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-gray-400 mb-1 uppercase">Score / Count</label>
                            <input type="number" step="0.5" className="w-full p-3 border-2 border-gray-200 rounded text-lg font-bold text-[#2c3e50] focus:border-[#3498db] outline-none" placeholder={form.subject === 'L' || form.subject === 'R' ? "è¾“å…¥åšå¯¹é¢˜æ•° (e.g. 8)" : "è¾“å…¥åˆ†æ•° (e.g. 6.5)"} value={form.score} onChange={e=>updateField('score', e.target.value)} />
                            {(form.subject === 'L' || form.subject === 'R') && <p className="text-[10px] text-gray-400 mt-1">*è¯·ç›´æ¥è¾“å…¥Section/Partçš„ç­”å¯¹æ•°é‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨èšåˆå¹¶è®¡ç®—é›…æ€åˆ†æ•°</p>}
                        </div>
                        {(form.subject === 'W' || form.subject === 'S') && (<div className="animate-in fade-in slide-in-from-top-2 duration-300"><label className="block text-xs font-bold text-gray-400 mb-1 uppercase">Topic è¯é¢˜</label><input type="text" className="w-full p-2 border border-gray-300 rounded text-sm" placeholder="e.g. Technology..." value={form.topic} onChange={e=>updateField('topic', e.target.value)} /></div>)}
                        <div className="bg-gray-50 p-3 rounded border border-gray-200">
                            <label className="block text-xs font-bold text-gray-400 mb-2 uppercase">Diagnosis</label>
                            <div className="flex flex-wrap gap-2">
                                {uniqueAvailableTags.map(tag => (
                                    <button key={tag} onClick={() => toggleTag(tag)} className={`px-2 py-1 rounded-full text-xs border transition-all ${form.tags.includes(tag) ? 'bg-[#2c3e50] text-white border-[#2c3e50]' : 'bg-white text-gray-500 border-gray-300 hover:border-[#2c3e50]'}`}>{tag}</button>
                                ))}
                                {showCustomTagInput ? (
                                    <div className="flex items-center gap-1">
                                        <input type="text" className="w-20 px-2 py-1 text-xs border border-gray-300 rounded" autoFocus placeholder="è‡ªå®šä¹‰..." value={customTag} onChange={e => setCustomTag(e.target.value)} onKeyDown={e => e.key === 'Enter' && addCustomTag()} />
                                        <button onClick={addCustomTag} className="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600">âœ“</button>
                                    </div>
                                ) : (
                                    <button onClick={() => setShowCustomTagInput(true)} className="px-2 py-1 rounded-full text-xs border border-dashed border-gray-400 text-gray-500 hover:bg-gray-100">+ è‡ªå®šä¹‰</button>
                                )}
                            </div>
                        </div>
                        <div><label className="block text-xs font-bold text-gray-400 mb-1 uppercase">Journal Note</label><textarea className="w-full p-2 border border-gray-300 rounded text-sm h-20 resize-none paper-texture" placeholder="è®°å½•ä»Šæ—¥å¿ƒå¾—..." value={form.note} onChange={e=>updateField('note', e.target.value)}></textarea></div>
                        <button onClick={handleSubmit} className="w-full bg-[#2c3e50] hover:bg-[#34495e] text-white font-bold py-4 rounded-lg shadow-lg transform active:scale-95 transition-all flex justify-center items-center gap-2"><Icons.Pen size={18} /> è®°å½•å¹¶æ¢ç´¢ (PAINT)</button>
                    </div>
                    <div className="grid grid-cols-2 gap-px bg-gray-300 border-t border-gray-300">
                        <button onClick={onOpenJournal} className="bg-gray-50 hover:bg-white p-4 text-sm font-bold text-gray-600 flex justify-center items-center gap-2"><Icons.Book size={16} /> å¤ç›˜æ‰‹è´¦</button>
                        <button onClick={onOpenData} className="bg-white hover:bg-gray-50 p-4 text-sm font-bold text-[#3498db] flex justify-center items-center gap-2"><Icons.Chart size={16} /> æ•°æ®ä¸­å¿ƒ</button>
                    </div>
                </div>
            );
        }

        function DataCenter({ records, onDeleteRecord, onClose }) {
            const [activeTab, setActiveTab] = useState('L');
            const [activePartFilter, setActivePartFilter] = useState('All');
            const [viewMode, setViewMode] = useState('list');
            const canvasRef = useRef(null);
            const pieCanvasRef = useRef(null);
            const chartInstance = useRef(null);
            const pieInstance = useRef(null);

            const config = SUBJECT_CONFIG[activeTab];
            const filteredRecords = records.filter(r => r.subject === activeTab);
            
            const stats = useMemo(() => processTestStats(records, activeTab), [records, activeTab]);

            const chartData = useMemo(() => {
                if (activePartFilter === 'All') {
                    return stats.trend; 
                } else {
                    return filteredRecords
                        .filter(r => r.part === activePartFilter)
                        .sort((a,b) => new Date(a.date) - new Date(b.date))
                        .map(r => ({
                            label: `${r.date.slice(5)}`, 
                            value: parseFloat(r.score)
                        }));
                }
            }, [activePartFilter, stats, filteredRecords]);

            const currentAvg = useMemo(() => {
                if (activePartFilter === 'All') return stats.avg;
                const partRecords = filteredRecords.filter(r => r.part === activePartFilter);
                if (partRecords.length === 0) return '-';
                const sum = partRecords.reduce((a, b) => a + parseFloat(b.score), 0);
                return (sum / partRecords.length).toFixed(1);
            }, [activePartFilter, stats, filteredRecords]);

            const currentCount = activePartFilter === 'All' ? stats.count : filteredRecords.filter(r => r.part === activePartFilter).length;

            const handleSwitchTab = (tab) => { 
                setActiveTab(tab); 
                setActivePartFilter('All'); 
            };

            useEffect(() => {
                if (canvasRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    
                    const trendData = chartData.slice(-15); 

                    let minVal = 0;
                    let maxVal = 9;
                    if (activePartFilter !== 'All' && (activeTab === 'L' || activeTab === 'R')) {
                        maxVal = 15; // Increased to 15 to accommodate P3/S4 extra questions
                    } else if (activePartFilter === 'All') {
                        minVal = 4; 
                    }

                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: trendData.map(d => d.label), 
                            datasets: [{ 
                                label: activePartFilter === 'All' ? 'Band Score' : 'Correct Count', 
                                data: trendData.map(d => d.value), 
                                borderColor: config.color, 
                                backgroundColor: config.color + '20', 
                                fill: true, 
                                tension: 0.4,
                                pointRadius: 4,
                                pointHoverRadius: 6
                            }]
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            scales: { 
                                y: { 
                                    beginAtZero: false, 
                                    min: minVal, 
                                    max: maxVal,
                                    grid: { borderDash: [2, 2] } 
                                },
                                x: { grid: { display: false } }
                            }, 
                            plugins: { legend: { display: false } } 
                        }
                    });
                }

                if (pieCanvasRef.current) {
                    if (pieInstance.current) pieInstance.current.destroy();
                    const tagCounts = {};
                    const diagRecords = activePartFilter === 'All' ? filteredRecords : filteredRecords.filter(r => r.part === activePartFilter);
                    
                    diagRecords.forEach(r => { r.tags.forEach(tag => { tagCounts[tag] = (tagCounts[tag] || 0) + 1; }); });
                    const labels = Object.keys(tagCounts);
                    const data = Object.values(tagCounts);
                    if (labels.length > 0) {
                        const pieCtx = pieCanvasRef.current.getContext('2d');
                        pieInstance.current = new Chart(pieCtx, {
                            type: 'doughnut',
                            data: { labels: labels, datasets: [{ data: data, backgroundColor: ['#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6', '#95a5a6'], borderWidth: 0 }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 10} } } } }
                        });
                    }
                }
                return () => { if(chartInstance.current) chartInstance.current.destroy(); if(pieInstance.current) pieInstance.current.destroy(); };
            }, [activeTab, chartData, config, activePartFilter]);

            const matrixData = useMemo(() => {
                if (viewMode !== 'grouped') return null;
                const books = {};
                filteredRecords.forEach(r => {
                    if (!books[r.book]) books[r.book] = {};
                    if (!books[r.book][r.test]) books[r.book][r.test] = {};
                    books[r.book][r.test][r.part] = r;
                });
                return books;
            }, [filteredRecords, viewMode]);

            return (
                <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center backdrop-blur-sm p-4">
                    <div className="bg-white w-full max-w-5xl h-[85vh] rounded-xl shadow-2xl flex overflow-hidden">
                        <div className="w-48 bg-gray-100 flex flex-col border-r border-gray-200">
                            <div className="p-6 font-black text-xl text-gray-700 tracking-tighter">DATA CENTER</div>
                            {Object.entries(SUBJECT_CONFIG).map(([k, v]) => (
                                <button key={k} onClick={() => handleSwitchTab(k)} className={`p-4 text-left font-bold transition-all border-l-4 ${activeTab === k ? 'bg-white text-gray-800 border-[#2c3e50]' : 'text-gray-400 border-transparent hover:bg-gray-200'}`}>{v.icon} {v.label.split(' ')[1]}</button>
                            ))}
                            <button onClick={onClose} className="mt-auto p-4 text-gray-500 hover:text-gray-800 flex items-center gap-2 font-bold text-sm border-t border-gray-200"><Icons.RotateCcw size={16}/> è¿”å›åœ°å›¾</button>
                        </div>
                        <div className="flex-1 p-8 overflow-y-auto bg-white">
                            <div className="flex justify-between items-end border-b border-gray-200 pb-4 mb-6">
                                <div>
                                    <h2 className="text-3xl font-bold text-gray-800 flex items-center gap-2" style={{ color: config.color }}>{config.icon} {config.label}</h2>
                                    
                                    <div className="flex gap-2 mt-3">
                                        <button 
                                            onClick={() => setActivePartFilter('All')} 
                                            className={`px-3 py-1 rounded-full text-xs font-bold transition-colors border ${activePartFilter === 'All' ? 'bg-[#2c3e50] text-white border-[#2c3e50]' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-100'}`}
                                        >
                                            å…¨éƒ¨ (Band Score)
                                        </button>
                                        {config.parts.map(p => (
                                            <button 
                                                key={p} 
                                                onClick={() => setActivePartFilter(p)} 
                                                className={`px-3 py-1 rounded-full text-xs font-bold transition-colors border ${activePartFilter === p ? 'bg-[#2c3e50] text-white border-[#2c3e50]' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-100'}`}
                                            >
                                                {p}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex gap-6 text-center">
                                    <div><div className="text-3xl font-black text-gray-700">{currentCount}</div><div className="text-xs font-bold text-gray-400 uppercase">{activePartFilter === 'All' ? 'Full Tests' : 'Records'}</div></div>
                                    <div><div className="text-3xl font-black text-gray-700">{currentAvg}</div><div className="text-xs font-bold text-gray-400 uppercase">{activePartFilter === 'All' ? 'Avg Band' : 'Avg Count'}</div></div>
                                </div>
                            </div>
                            <div className="grid grid-cols-12 gap-6 mb-8">
                                <div className="col-span-8 bg-gray-50 p-4 rounded-xl border border-gray-100 h-64 relative shadow-sm">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-2">
                                        {activePartFilter === 'All' ? 'Complete Test Trend (å®Œæ•´æ¨¡è€ƒèµ°åŠ¿)' : `${activePartFilter} Trend (å•é¡¹æ­£ç¡®æ•°èµ°åŠ¿)`}
                                    </h3>
                                    <div className="h-52 w-full">
                                        {chartData.length > 0 ? <canvas ref={canvasRef} /> : <div className="h-full flex items-center justify-center text-gray-400 italic">æš‚æ— æ•°æ®</div>}
                                    </div>
                                </div>
                                <div className="col-span-4 bg-gray-50 p-4 rounded-xl border border-gray-100 h-64 relative shadow-sm">
                                    <h3 className="text-xs font-bold text-gray-400 uppercase mb-2">Diagnosis é”™è¯¯å½’å› </h3>
                                    <div className="h-52 w-full">{filteredRecords.length > 0 ? <canvas ref={pieCanvasRef} /> : <div className="h-full flex items-center justify-center text-gray-400 italic">æš‚æ— æ•°æ®</div>}</div>
                                </div>
                            </div>
                            <div className="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm">
                                <div className="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                    <h3 className="font-bold text-gray-600 text-sm">ç»ƒä¹ è®°å½•</h3>
                                    <div className="flex gap-2">
                                        <button onClick={() => setViewMode('list')} className={`p-1 rounded ${viewMode==='list'?'bg-white shadow text-[#2c3e50]':'text-gray-400'}`} title="åˆ—è¡¨è§†å›¾"><Icons.List size={16}/></button>
                                        <button onClick={() => setViewMode('grouped')} className={`p-1 rounded ${viewMode==='grouped'?'bg-white shadow text-[#2c3e50]':'text-gray-400'}`} title="çŸ©é˜µè§†å›¾"><Icons.Layers size={16}/></button>
                                    </div>
                                </div>
                                {viewMode === 'list' ? (
                                    <table className="w-full text-sm">
                                        <thead className="bg-gray-50 text-gray-500 border-b border-gray-200"><tr><th className="p-3 text-left">Date</th><th className="p-3 text-left">Source</th><th className="p-3 text-left">Input</th>{(activeTab === 'W' || activeTab === 'S') && <th className="p-3 text-left">Topic</th>}<th className="p-3 text-left">Tags</th><th className="p-3 w-10"></th></tr></thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {filteredRecords.slice(0, 20).map((r) => (
                                                <tr key={r.id} className="hover:bg-gray-50">
                                                    <td className="p-3 font-mono text-gray-500">{r.date.slice(5)}</td>
                                                    <td className="p-3 font-medium">{r.book} {r.test} <span className="text-xs bg-gray-200 px-1 rounded ml-1">{r.part}</span></td>
                                                    <td className="p-3 font-bold text-gray-800">{r.score}</td>
                                                    {(activeTab === 'W' || activeTab === 'S') && <td className="p-3 text-gray-600 truncate max-w-[150px]">{r.topic || '-'}</td>}
                                                    <td className="p-3"><div className="flex gap-1 flex-wrap">{r.tags.map(t => <span key={t} className="text-[10px] px-2 py-0.5 rounded-full border border-gray-200 text-gray-500">{t}</span>)}</div></td>
                                                    <td className="p-3 text-center"><button onClick={() => onDeleteRecord(r.id)} className="text-gray-300 hover:text-red-500 transition-colors" title="åˆ é™¤è®°å½•"><Icons.Trash size={16} /></button></td>
                                                </tr>
                                            ))}
                                            {filteredRecords.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-gray-400 italic">æš‚æ— ç»ƒä¹ è®°å½•</td></tr>}
                                        </tbody>
                                    </table>
                                ) : (
                                    <div className="p-6 space-y-8">
                                        {(activeTab === 'L' || activeTab === 'R') ? Object.entries(matrixData).map(([book, tests]) => (
                                            <div key={book} className="border border-gray-200 rounded-lg overflow-hidden">
                                                <div className="bg-[#2c3e50] text-white p-2 px-4 font-bold text-sm">{book}</div>
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm text-center">
                                                        <thead className="bg-gray-50 text-gray-500 text-xs uppercase">
                                                            <tr>
                                                                <th className="p-2 w-20 text-left pl-4">Test</th>
                                                                {config.parts.map(p => <th key={p} className="p-2">{p}</th>)}
                                                                <th className="p-2 w-24 font-bold text-[#2c3e50]">Band</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {['Test 1', 'Test 2', 'Test 3', 'Test 4'].map(testName => {
                                                                const testData = tests[testName] || {};
                                                                // è®¡ç®—è¡Œæ€»åˆ†
                                                                let totalCount = 0;
                                                                let hasAllParts = true;
                                                                config.parts.forEach(p => {
                                                                    if (testData[p]) totalCount += parseFloat(testData[p].score);
                                                                    else hasAllParts = false;
                                                                });
                                                                const band = hasAllParts ? getBandScore(totalCount, activeTab) : '-';
                                                                const isEmpty = Object.keys(testData).length === 0;

                                                                return (
                                                                    <tr key={testName} className={isEmpty ? "bg-gray-50/30" : "hover:bg-blue-50"}>
                                                                        <td className="p-3 text-left pl-4 font-medium text-gray-600">{testName}</td>
                                                                        {config.parts.map(p => {
                                                                            const rec = testData[p];
                                                                            return (
                                                                                <td key={p} className="p-2 border-l border-gray-100 relative group">
                                                                                    {rec ? (
                                                                                        <>
                                                                                            <span className="font-bold text-gray-800">{rec.score}</span>
                                                                                            <button onClick={() => onDeleteRecord(rec.id)} className="absolute top-1 right-1 text-red-300 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-opacity"><Icons.X size={10} /></button>
                                                                                        </>
                                                                                    ) : <span className="text-gray-200">-</span>}
                                                                                </td>
                                                                            );
                                                                        })}
                                                                        <td className="p-2 border-l border-gray-200 font-bold text-[#3498db] bg-blue-50/30">
                                                                            {band}
                                                                        </td>
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )) : (
                                            <div className="text-center text-gray-400 py-10">çŸ©é˜µè§†å›¾ä»…é€‚ç”¨äº å¬åŠ› (L) å’Œ é˜…è¯» (R)</div>
                                        )}
                                        {Object.keys(matrixData || {}).length === 0 && <div className="text-center text-gray-400 italic">æš‚æ— æ•°æ®</div>}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function Journal({ records, onClose }) {
            const notes = records.filter(r => r.note);
            return (
                <div className="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center backdrop-blur-sm p-4">
                    <div className="bg-[#fffbf0] w-full max-w-2xl h-[80vh] rounded shadow-2xl flex flex-col relative paper-texture border-l-8 border-[#5d4037]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500"><Icons.X size={24} /></button>
                        <div className="p-8 border-b border-[#e0e0e0]"><h2 className="text-2xl font-serif font-bold text-[#5d4037] flex items-center gap-2"><Icons.Book size={24} /> Captain's Log å¤‡è€ƒæ‰‹è´¦</h2></div>
                        <div className="flex-1 overflow-y-auto p-8">{notes.length === 0 ? (<div className="text-center text-gray-400 italic mt-20">è¿˜æ²¡æœ‰å†™ä¸‹ä»»ä½•å¿ƒå¾—...</div>) : (<div className="space-y-8">{notes.map(r => (<div key={r.id} className="relative pl-6 border-l-2 border-[#e67e22]"><div className="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-[#e67e22] border-4 border-[#fffbf0]"></div><div className="text-xs font-mono text-gray-400 mb-1">{r.date} â€¢ {r.subject}</div><div className="text-[#2c3e50] leading-relaxed whitespace-pre-wrap font-serif">{r.note}</div><div className="mt-2 flex gap-2"><span className="text-[10px] bg-[#e0e0e0] px-2 rounded text-gray-600">{r.book} {r.test}</span>{r.score && <span className="text-[10px] bg-[#e0e0e0] px-2 rounded text-gray-600">Score: {r.score}</span>}</div></div>))}</div>)}</div>
                    </div>
                </div>
            );
        }

        function HandDrawnMap({ records, mapResetDate, mapCycle, onMapReset, unlockedLandmarks, totalLandmarksCount, totalCountriesCount, onShowLandmark }) {
            const [mapFeatures, setMapFeatures] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(false);
            const [transform, setTransform] = useState({ k: 0.75, x: 100, y: 50 });
            const [isDragging, setIsDragging] = useState(false);
            const [dragStart, setDragStart] = useState({ x: 0, y: 0 });
            const [retryCount, setRetryCount] = useState(0);
            const [hoveredCountry, setHoveredCountry] = useState(null); 
            const [tooltipPos, setTooltipPos] = useState({ x: 0, y: 0 });

            useEffect(() => {
                setLoading(true); setError(false);
                fetch(GEOJSON_URL).then(res => { if (!res.ok) throw new Error('Network error'); return res.json(); }).then(data => { setMapFeatures(data.features); setLoading(false); }).catch(err => { console.error(err); setLoading(false); setError(true); });
            }, [retryCount]);

            const project = (lon, lat) => { const width = 800; const height = 450; const x = (lon + 180) * (width / 360); const y = height - ((lat + 90) * (height / 180)); return [x, y]; };
            const generatePath = (feature) => {
                const type = feature.geometry.type; const coords = feature.geometry.coordinates;
                const drawPoly = (rings) => { let p = ""; rings.forEach(ring => { ring.forEach((pt, i) => { const [x, y] = project(pt[0], pt[1]); p += (i === 0 ? "M" : "L") + `${x},${y} `; }); p += "Z "; }); return p; };
                if (type === "Polygon") return drawPoly(coords); else if (type === "MultiPolygon") { let p = ""; coords.forEach(poly => p += drawPoly(poly)); return p; } return "";
            };

            const mapData = useMemo(() => {
                const statusMap = {}; 
                const activeRecords = records.filter(r => new Date(r.date) >= mapResetDate && (r.subject === 'L' || r.subject === 'R') && r.countryId);
                
                activeRecords.forEach(r => {
                    if (!statusMap[r.countryId] || parseFloat(r.score) > parseFloat(statusMap[r.countryId].record.score)) {
                        statusMap[r.countryId] = { record: r };
                    }
                });

                return mapFeatures.map((f, i) => {
                    const recordInfo = statusMap[f.id];
                    let statusClass = 'fill-default';
                    if (recordInfo) {
                        const s = parseFloat(recordInfo.record.score);
                        if (s >= 8.0) statusClass = 'fill-high';
                        else if (s >= 6.5) statusClass = 'fill-mid'; 
                        else if (s >= 5.0) statusClass = 'fill-pass'; 
                        else statusClass = 'fill-low';
                    }
                    
                    return {
                        id: f.id,
                        name: f.properties.name,
                        cnName: COUNTRY_CN_MAP[f.id] || '',
                        d: generatePath(f),
                        statusClass,
                        record: recordInfo ? recordInfo.record : null
                    };
                });
            }, [mapFeatures, records, mapResetDate]);

            const litCountriesCount = mapData.filter(c => c.statusClass !== 'fill-default').length;
            const isMapFull = litCountriesCount > 0 && litCountriesCount === totalCountriesCount;

            const handleWheel = (e) => { e.preventDefault(); const newK = Math.min(Math.max(e.deltaY < 0 ? transform.k * 1.1 : transform.k / 1.1, 1), 8); setTransform(p => ({ ...p, k: newK })); };
            const handleMouseDown = (e) => { setIsDragging(true); setDragStart({ x: e.clientX - transform.x, y: e.clientY - transform.y }); };
            const handleMouseMove = (e) => {
                if (isDragging) {
                    setTransform(p => ({ ...p, x: e.clientX - dragStart.x, y: e.clientY - dragStart.y }));
                }
            };
            const handlePathHover = (e, country) => {
                if (country.record) {
                    const rect = e.target.getBoundingClientRect();
                    setTooltipPos({ x: rect.left + rect.width / 2, y: rect.top - 10 });
                    setHoveredCountry(country);
                } else {
                    setHoveredCountry(null);
                }
            };

            return (
                <div className="w-full h-full relative overflow-hidden flex items-center justify-center bg-[#89cff0]"> 
                    
                    {/* HUD */}
                    <div className="absolute top-6 left-6 z-20 flex gap-4 font-['Inter']">
                        <div className="hud-card">
                            <div className="hud-header">
                                <span>WORLD EXPLORATION</span>
                                <span className="hud-level">Level {mapCycle}</span>
                            </div>
                            <div className="hud-progress-bg">
                                <div className="hud-progress-bar" style={{ width: `${(litCountriesCount / totalCountriesCount) * 100}%` }}></div>
                            </div>
                            <div className="hud-value">
                                {litCountriesCount} / {totalCountriesCount} Countries
                            </div>
                             {isMapFull && <button onClick={onMapReset} className="text-[10px] text-red-500 font-bold mt-1 animate-pulse hover:underline text-right block w-full">LEVEL UP &gt;</button>}
                        </div>

                        <div className="hud-card">
                            <div className="hud-header">
                                <span>LANDMARK COLLECTION</span>
                                <Icons.Trophy size={16} className="hud-trophy" />
                            </div>
                            <div className="hud-progress-bg">
                                <div className="hud-progress-bar bg-[#EAB308]" style={{ width: `${(unlockedLandmarks.length / totalLandmarksCount) * 100}%` }}></div>
                            </div>
                            <div className="hud-value text-left">
                                {unlockedLandmarks.length} / {totalLandmarksCount} Collected
                            </div>
                        </div>
                    </div>

                    <svg className="absolute w-0 h-0"><defs><filter id="wavy"><feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" result="noise" /><feDisplacementMap in="SourceGraphic" in2="noise" scale="2" /></filter><pattern id="pencil-hatch" width="8" height="8" patternUnits="userSpaceOnUse" patternTransform="rotate(45)"><line x1="0" y1="0" x2="0" y2="8" stroke="#d4ac0d" strokeWidth="2" /></pattern></defs></svg>
                    
                    {/* Controls */}
                    <div className="absolute bottom-56 right-8 z-10 flex flex-col gap-2"><button onClick={() => setTransform(p => ({ ...p, k: Math.min(p.k * 1.2, 8) }))} className="bg-white p-2 rounded shadow hover:bg-gray-100"><Icons.Plus size={20}/></button><button onClick={() => setTransform(p => ({ ...p, k: Math.max(p.k / 1.2, 1) }))} className="bg-white p-2 rounded shadow hover:bg-gray-100"><Icons.Minus size={20}/></button><button onClick={() => setTransform({ k: 0.75, x: 100, y: 50 })} className="bg-white p-2 rounded shadow hover:bg-gray-100"><Icons.Refresh size={20}/></button>{error && <button onClick={() => setRetryCount(c => c + 1)} className="bg-red-100 text-red-600 p-2 rounded shadow animate-pulse"><Icons.Refresh size={20}/></button>}</div>
                    
                    {/* Bottom Shelf */}
                    <div className="absolute bottom-0 left-0 w-full h-52 bg-gradient-to-t from-white/30 to-transparent z-20 flex items-center px-8 gap-10 overflow-x-auto scrollbar-hide pb-4 pt-2">
                        {unlockedLandmarks.length === 0 && <div className="text-white/80 text-xl italic w-full text-center font-bold tracking-widest drop-shadow-md">å®Œæˆå†™ä½œ/å£è¯­ç»ƒä¹ æ¥è§£é”åœ°æ ‡æ”¶è—...</div>}
                        {unlockedLandmarks.map((lm, i) => (
                            <div key={i} onClick={() => onShowLandmark(lm)} className="flex-shrink-0 w-40 h-48 bg-white shadow-2xl p-2 cursor-pointer hover:scale-110 transition-all duration-300 stamp-card transform rotate-1 hover:rotate-0" title={lm.name}>
                                <div className="w-full h-full overflow-hidden rounded-sm border border-gray-100 relative">
                                     <img src={lm.img} className="w-full h-full object-cover" />
                                     <div className="absolute bottom-0 left-0 w-full bg-white/90 p-2 text-center text-sm font-bold text-gray-600 truncate">{lm.name}</div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {loading ? (<div className="flex flex-col items-center text-white/50 gap-2"><Icons.Loader className="animate-spin" size={32} /><p>Drawing World Map...</p></div>) : error ? (<div className="text-white/50">Map Data Error</div>) : (
                        <>
                            <svg viewBox="0 0 800 450" className={`w-full h-full transition-cursor ${isDragging ? 'cursor-grabbing' : 'cursor-grab'}`} onWheel={handleWheel} onMouseDown={handleMouseDown} onMouseMove={handleMouseMove} onMouseUp={() => setIsDragging(false)} onMouseLeave={() => {setIsDragging(false); setHoveredCountry(null);}}>
                                <pattern id="waves" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M0 10 Q5 5 10 10 T20 10" fill="none" stroke="#ffffff" strokeWidth="1" opacity="0.3"/></pattern>
                                <g transform={`translate(${transform.x}, ${transform.y}) scale(${transform.k})`}><rect x="-4000" y="-4000" width="8000" height="8000" fill="url(#waves)" /><g transform="translate(0, 50) scale(1, 0.85)">
                                    {mapData.map((c, i) => (
                                        <g key={i} className="group" onMouseEnter={(e) => handlePathHover(e, c)} onMouseLeave={() => setHoveredCountry(null)}>
                                            <path d={c.d} className={`transition-colors duration-500 ease-out ${c.statusClass}`} vectorEffect="non-scaling-stroke" style={{ filter: 'url(#wavy)' }} />
                                            {c.statusClass !== 'fill-default' && <path d={c.d} fill="url(#pencil-hatch)" opacity="0.3" style={{ pointerEvents: 'none' }} />}
                                        </g>
                                    ))}
                                </g></g>
                            </svg>
                            {hoveredCountry && (
                                <div className="fixed z-50 bg-white p-3 rounded-lg shadow-xl border-l-4 border-[#2c3e50] text-sm pointer-events-none tooltip-enter" style={{ left: tooltipPos.x, top: tooltipPos.y }}>
                                    <div className="font-bold text-gray-800">ğŸ‰ æ­å–œç‚¹äº® {hoveredCountry.cnName} ({hoveredCountry.name})</div>
                                    <div className="text-xs text-gray-500 mt-1">ğŸ“… {hoveredCountry.record.date}</div>
                                    <div className="text-xs font-mono text-blue-600 mt-1">ğŸ“š {hoveredCountry.record.book} {hoveredCountry.record.test} {hoveredCountry.record.part}</div>
                                    <div className="text-xs font-bold text-[#f1c40f] mt-1">Score/Count: {hoveredCountry.record.score}</div>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>